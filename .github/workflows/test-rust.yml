name: Rust Extension Tests

on:
  pull_request:
    branches: [main]
    paths: [extensions/rust/**, .github/workflows/test-rust.yml]
  push:
    branches: [main]
    paths: [extensions/rust/**, .github/workflows/test-rust.yml]
  workflow_dispatch:

jobs:
  rust-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: extensions/rust
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            extensions/rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('extensions/rust/Cargo.toml') }}
          restore-keys: ${{ runner.os }}-cargo-
      - name: Check formatting
        run: cargo fmt --check
      - name: Run clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: Run tests
        run: cargo test

  python-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: extensions/rust
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            extensions/rust/target
          key: ${{ runner.os }}-cargo-py-${{ hashFiles('extensions/rust/Cargo.toml') }}
          restore-keys: ${{ runner.os }}-cargo-py-
      - name: Build and install ferrox
        run: |
          uv pip install maturin --system
          maturin build --features python --release
          uv pip install target/wheels/*.whl --system
      - name: Install test dependencies
        run: uv pip install pymatgen numpy --system
      - name: Run Python tests
        run: python tests/test_pymatgen_compat.py --regression
